Проект Радио-86РК на железе Maximite
====================================

**ВНИМАНИЕ** *Данный документ не является полноценной документацией. Здесь
собраны некоторые полезные факты. Для более детальной информации надо
смотреть код или можно написать мне письмо.*

Можно для начала посмотреть парочку видео -- [1][] и [2][].

[1]: http://www.youtube.com/watch?v=dIwQQYhqNQg
[2]: http://www.youtube.com/watch?v=KSUZ2yjPuU0

Программный эмулятор процессора Intel 8080 (КР580) и аппаратуры Радио-86РК
работает на микрокомпьютере Maximite. Maximite основан на PIC32. Тактовая
частота PIC32 80MHz, частота эмулируемого КР580 - 1.78MHz. 

[Maximite]: http://geoffg.net/maximite.html


Процессор
=========

Частота Intel 8080
------------------

    1.78MHz (16/9)

    1,780,000Hz

    T = 1 / 1780000 = 0.0000005625s = 0.0005625ms = 0.5625mks = 5.625us (РК86)

Частота PIC32
-------------

    80MHz = 80,000,000

    T = 1 / 80000000 = 0.0000000125s = 0.0000125ms = 0.0125mks = 0.125us

    PIC32_FREQ = 80000000
    I8080_RK86_FREQ = 1780000

Длительность такта I8080 в тактах PIC32
---------------------------------------

    RK86_I8080_PERIOD = PIC32_FREQ / I8080_RK86_FREQ = ~45


Видео
=====

Программно создается видео сигнал VGA. Подробности в файле `video.c`. 
Эмуляция экрана РК (знакогенератора и курсора) -- файл `rk86_video.c`.

Размер кадра реально берется из тех установок, которые делает Монитор.
Например, некоторые игры меняют вертикальное разрешение с 30 символов на 35.

В пикселях (по умолчанию):

    480 x 300

В знакоместах:

    480 / 6 = 80
    300 / 80 = 30

Экран РК86
----------

Некоторые удобные константы для понимания экрана РК.

    screen_width = 78
    screen_height = 30

    char_width = 6
    char_height = 8
    char_height_gap = 2

    cursor_width = char_width
    cursor_height = 1

    canvas_width = screen_width * char_width * scale_x
    canvas_height = screen_height * (char_height + char_height_gap) * scale_y


Клавиатура
==========

- Стандартный PS/2 протокол (`keyboard.c`)
- [Коды клавиш](http://www.computer-engineering.org/ps2keyboard/scancodes2.html)


Звук
====

Команды процессора EI/DI, используемые в РК для генерации звука,
соответственно, выставляют и сбрасывают бит `PORTBbits.RB4`.

Внешняя пищалка подключена на ножку RB4. Пищалкой является любой низкоомный
небольшой динамик, подключенный последовательно через неинвертирующий буфер
и емкость в 10mkF (для защиты по постоянному току). Схема включения аналогична
оригинальной из РК.

                   +-----+    C1 10mkF
    6 (RB4)      3 |     | 2   ||+
    >--------------+     +-----||------+
    4 (+5V)      8 |     |     ||      |
    >--------------+     |             |
    2 (GND)      1 |     |            +++        
    >-------+------+     |            | |/|  SP1 
            |      +-----+            | |\|      
            |        IC1              +++       
            |     74HC4050E            |
            |                          |     
          --+--                      --+-- GND

Ножка RB4 заведена на пин GIO 6 (в нотации MMBasic). На физическом разъеме
Maximite это пин номер 6. Питания для IC1 берется с пина 4. Земля - пин 2.
Так как все эти три ножки на разъеме расположены рядом, их удобно подключить
трехпиновым проводочком с разъемом на конце.

Ножка `PORTBbits.RB4`.

Программирование на вывод:

        TRISBbits.TRISB4 = 0
        
Управление:

        PORTBbits.RB4 = on


"Железки" Maximite
==================

Полная информация о Maximite находится на его официальном сайте.
Тут я собрал только минимум, относящийся к Радио-86РК.

Зеленый светодиод
-----------------

Ножка `PORTFbits.RF0`.

Программирование на вывод:

    TRISFbits.TRISF0 = 0

Управление:

    PORTFbits.RF0 = on

Красный светодиод
-----------------

Ножка `PORTEbits.RE1`.

Программирование на вывод:

    TRISEbits.TRISE1 = 0

Управление:

    PORTEbits.RE1 = on

Микро-тумблер для перевода в режим Bootloader'а
-----------------------------------------------

Ножка `PORTCbits.RC13`.

Программирование на ввод:

    TRISCbits.TRISC13 = 1

Проверка:

    if (PORTCbits.RC13 == 0) SoftReset()


Сборка прошивки
===============

Требуется компилятор XC32. Если у вас демо-версия, то надо поменять `-O3` на
`-O1`.

    make

Загрузка (Maximite должен быть в режиме bootloader'а):

    make load

Для загрузки требуется программа [mphidflash][].

[mphidflash]: https://github.com/begoon/mphidflash

**Внимание**. Скрипт линкера `Maximite.ld` работается **только** с компиляторами
Microchip (C32 или XC32).

Компилятор `chipkit32` (https://github.com/jasonkajita/chipKIT-cxx/downloads)
тоже прекрасно собирает проект:

    export CHIPKIT32=1 make

Но, увы, бинарь не запускается. Какая-то проблема в скрипте линкера
`Maximite.ld.chipkit32`.

**Если кто подскажет, как правильно собирать chipkit'м -- буду очень
признателен.**


Команды USB-консоли
===================

*Список не полный и постоянно обновляется*.

* `ls` - список файлов на флешке
* `load file_name`
* `run file_name`
* `rom` - список файлов на ROM-диске
* `rom file_name` - загрузить файл из ROM
* `go address`

Игры и прочие программы
=======================

Здесь собрана разрозненная информация по играм и прочим программам из каталога
`./files`. Файлов в каталоге больше, чем перечисленно тут. 
**Список постоянно обновляется**.

    CPM.RKR      - Что-то, но не OS CP/M

    LINKRK.RKR   - Программа связи компьютеров через ППА-ВА55А.

    MUSIC.RKR    - Музыкальная система МС 3.2 (отличается на пару байт от PMS.PKI, но визуально отличия непонятны).
    MUZ_SYST.RKR - Музыкальная система МС 3.2 (отличается многими байтами от PMS.PKI и MUSIC.RKR, но визуально отличия непонятны).
    MUZUKRED.RKR - Музыкальный редактор Виртуоз.

    MORSE16.RKR  - Что-то как-то работающее для азбуки Морзе (UT5DE/UA3 CW RX).

    REDASM.RKR   - REDASSM V.2.M
    ASM_ED.RKR   - Редактор и ассемблер Микрон (реально не работает, редактор ругается на МАЛО ОЗУ).
    ASM-ED.RK    - Немного другой файл (отличается на пару десятков байт, и вроде работает).
    ASSM_MIC.RKR - Ассемблер Микроша.
    CONSTMAG.RKR - Что-то для магнитофонной константы (непонятно, что программа делает).
    ED-DSSM.RKR  - Редактор и дизассемблер Микрон.
    ED-DSSM2.RKR - Редактор и дизассемблер Микрон (отличается на пару байт от ED-DSSM.RKR, но визуально отличия непонятны).
    DSSM-CPM.RKR - Дизассемблер от Ward Christersen (не удалось заставить работать, может неверный адрес загрузки).

    PASCAL.RKR   - PASCAL-МФТИ V01 (Микроша).

    BASIC80.RKR  - Бейсик *РАДИО-86РК* BASIC "OK"
    BASICSER.RKR - Бейсик *РАДИО-86РК* BASIC "OK" (файл отличается от BASIC80.RKR).
    BASIC.RK     - Бейсик BASIC " ==>"
    BASIC_OK.PKI - Бейсик BASIC "OK :" (глючит, при работе может выводит мусор и вываливаться в Монитор)
    BAS_MICR.PKI - Бейсик BASIC *МИКРОН* "NEW?"
    BS_M_OLD.RKR - Бейсик BASIC *МИКРОН* "ЖДУ:" (файл сильно отличается от BAS_MICR.PKI).
    BASIC_PR.PKI - Бейсик *РАДИО-86РК* BASIC "=>"
    BASIC_RK.RKR - Бейсик *РАДИО-86РК* BASIC "=>" (файл отличается от BASIC_PR.PKI, но визуально отличия непонятны).
    BASMIC.RKR   - Бейсик *МИКРОША* BASIC "=>"
    BASICPC.RKR  - Бейсик BASIC *RADIO-86PC* "READY!"
    BS_PSF.RKR   - Бейсик PSF BASIC 32K V3.2
    BASICMUS.RKR - Бейсик PSF BASIC 32K V3.2 (файл значительно отличается от BS_PSF.RKR, но визуально отличия непонятны).
    BS_SVVI.RKR  - Бейсик *SVVI-76/79* BASIC

    ED-SORT.RKR  - Редактор *SORT UT* V1.1.
    WEL.RKR      - Редактор WEL 2.0
    SP_COMP.RKR  - Space compressor для WEL.

    HEXEDIT1.RKR - HEX-редактор и программатор П/ПЗУ.
    HEXEDIT2.RKR - Немного другой файл, но отличия непонятны.
    PROGR0.RKR   - Программатор "ПОШЛА ПРОШИВКА ПЗУ" (стартовый адрес 0000).
    PROGR0.RKR   - Программатор "ПОШЛА ПРОШИВКА ПЗУ" (копия PROGR0.RKR, но стартовый адрес 1000).
    PROGR2.RKR   - Программатор ПЗУ.
    PROGR3.RKR   - Еще программатор ПЗУ.

    BARMEN.RK    - Бармен
    CHUDOV.RK    - Чудовище
    DESCENT.RK   - Спуск
    KLAD.RK      - Игра Rase (файл отличается на несколько байт).
    LESTN.RK     - Лестница-1 (файл сильно отличается от LESTN1.GAM).
    LOMAZE.RK    - Игра Maze (файл сильно отличается от MAZE.GAM).
    PACMAN.RK    - Вариант Pacman'а.
    PENTIS.RK    - Тетрис 5
    PITON.RK     - Практически аналог PITON.GAM.
    PRESS.RK     - Игра Press.
    ROCKER.RK    - Чем-то напоминает Boulder Dash.
    SKACHKI.RK   - Вариант скачек для одного игрока.
    SLAMS.RK     - Игра Slams.
    SPYSDEM.RK   - Видимо, та же игра, что и SDEMISE.GAM, но отличающийся файл с другим стартовым адресом.
    STELBY.RK    - Стелби (управлять вертолетом и стрелять).
    TENNIS.RK    - Теннис (типа Арканоида).
    TETR2.RK     - Тетрис
    TETRIS2.RK   - Аналогичен TETR2.RK, но сильно другой файл.
    ZMEI.RK      - Змей-Горыныч (Питон, в реальности).
    ZMEYA.RK     - Змея (своеобразный Питон).

    DISASM.RK    - Дисассемблер Микрон.
    DEBUG.RK     - Отличается на десяток байт, но визуально отличия непонятны.

    LIQSKY.RK    - Игра Liquid Sky (показывает только мигающую заставку).
    COA.RK       - Версия удава (не работает управление).
    RALLI.RK     - Ралли (показывает только заставку).
    SCHOPER.RK   - Super Choper (запускается, но глючит в игре).
    TETRIS3.RK   - Виснет при выборе уровня.

    RAMDOS.PKI   - Какой-то кусок (при запуске выводит мусор).
    RDISK1.PKI   - Работающие диски RAMDOS с какой-то хренью.
    RDISK2.PKI
    RDISK3.PKI
    RDISK4.PKI
    RDISK5.PKI
    RDISK6.PKI
    RDISK7.PKI
    RDISK8.PKI

Виснут при запуске 
------------------

Эти файлы убраны в каталог `./files/broken`. Возможно, эти программы от 
других клонов РК.

    CROSSFIR.RK
    DIGGER.RK
    DIGGER1.RK
    FROGGI15.RK
    GOLD.RK
    GONKA.RK
    LDRUNNER.RK
    MIRAZH.RK
    PANIKA.RK
    BLDRDASH.RK
    PERELET.RK
    PINGPONG.RK
    RISE.RK
    RISE1.RK
    SAMOLET.RK
    SHAKHTA.RK
    SHTAB.RK
    XTRO.RK
    Z-STATIO.RKR


ROM диск
========

В каталоге `./rom/files` находятся файлы, которые при сборке "вшиваются" в
бинарь эмулятора. Файлы, кроме знакогенератора, комрессируются.
